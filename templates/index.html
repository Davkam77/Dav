<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üîç –ü–æ–∏—Å–∫ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–∫–∞–∑–æ–≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
</head>
<body style="background: url('{{ background }}') no-repeat center center fixed; background-size: cover;">

<!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chatWindow">
    <div class="chat-header">üí¨ –ß–∞—Ç</div>
    <div id="chatMessages"></div>
    <div class="chat-input-wrapper">
        <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="chatSend">‚û§</button>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
<button type="button" class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

<!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
<nav id="sideMenu" class="side-menu">
    <ul>
        <li><a href="/index">üè† –ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/favorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</a></li>
        <li><a href="/my_tasks">üß∞ –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</a></li>
        <li><a href="/completions">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</a></li>
        <li><a href="/logout">üö™ –í—ã–π—Ç–∏</a></li>
    </ul>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="main-content">
    <header>
        <h1 class="glow">üîç –ü–æ–∏—Å–∫ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–∫–∞–∑–æ–≤</h1>
    </header>

    <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Ñ–æ—Ä–º–∞ -->
    <form class="search-box" onsubmit="sendQuery(event)">
        <input type="text" id="query" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AI 100" required>
        <button type="submit">–ù–∞–π—Ç–∏</button>
        <button type="button" id="filter-icon" onclick="toggleFilters()">
            <img src="{{ url_for('static', filename='filter-icon.png') }}" alt="–§–∏–ª—å—Ç—Ä">
        </button>
    </form>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="filter-panel" aria-hidden="true">
        <form id="filter-form" onsubmit="applyFilters(event)">
            <fieldset>
                <legend>–§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</legend>
                <label for="min-budget">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç ($):</label>
                <input type="number" id="min-budget" min="0" placeholder="100" aria-describedby="budget-desc">
                <p id="budget-desc" class="sr-only">–£–∫–∞–∂–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö.</p>

                <label for="region-select">–†–µ–≥–∏–æ–Ω:</label>
                <select id="region-select" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="India">–ò–Ω–¥–∏—è</option>
                    <option value="United States">–°–®–ê</option>
                    <option value="Australia">–ê–≤—Å—Ç—Ä–∞–ª–∏—è</option>
                </select>

                <label for="payment-type">–¢–∏–ø –æ–ø–ª–∞—Ç—ã:</label>
                <select id="payment-type">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="Fixed Price">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞</option>
                    <option value="Hourly">–ü–æ—á–∞—Å–æ–≤–∞—è</option>
                </select>

                <label for="experience-select">–û–ø—ã—Ç:</label>
                <select id="experience-select">
                    <option value="">–õ—é–±–æ–π</option>
                    <option value="Entry">–ù–∞—á–∞–ª—å–Ω—ã–π</option>
                    <option value="Intermediate">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="Expert">–≠–∫—Å–ø–µ—Ä—Ç</option>
                </select>

                <label for="max-hours">–ú–∞–∫—Å. —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é:</label>
                <input type="number" id="max-hours" min="0" placeholder="40">

                <label for="max-deadline">–ú–∞–∫—Å. –¥–µ–¥–ª–∞–π–Ω (–¥–Ω–µ–π):</label>
                <input type="number" id="max-deadline" min="0" placeholder="7">

                <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button type="reset" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </fieldset>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <button id="notif-filter-toggle" type="button" title="–§–∏–ª—å—Ç—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
        <img src="{{ url_for('static', filename='filter-icon2.png') }}" style="width: 50px; height: 50px;" alt="–§–∏–ª—å—Ç—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
    </button>
    <div id="notif-filter-panel" class="">
        <form id="notif-filter-form" onsubmit="saveUserFilters(event)">
            <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            <label for="filter-keywords">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</label>
            <input type="text" id="filter-keywords" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: AI, crypto">
            <label for="filter-min-price">–ú–∏–Ω. —Ü–µ–Ω–∞:</label>
            <input type="number" id="filter-min-price" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 100">
            <label for="filter-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select id="filter-category">
                <option value="">–í—Å–µ</option>
                <option value="Web Development">Web Development</option>
                <option value="Design">Design</option>
                <option value="Marketing">Marketing</option>
            </select>
            <label for="filter-telegram">–í–∞—à Telegram ID:</label>
            <input type="text" id="filter-telegram" placeholder="123456789 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required>
            <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading">
        <div class="loader-spinner"></div>
        <div class="loading-dots">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <p id="job-stats" style="text-align: center; margin-top: 10px;"></p>
    <div id="cards" class="cards"></div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="toast-container"></div>

<!-- –ê—É–¥–∏–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<audio id="notify-sound" src="{{ url_for('static', filename='legendary-stick-131717.mp3') }}" preload="auto"></audio>

<!-- JavaScript -->
<script>
function toggleMenu() {
    const menu = document.getElementById("sideMenu");
    const toggle = document.querySelector(".menu-toggle");
    menu.classList.toggle("open");
    toggle.style.transform = menu.classList.contains("open") ? "rotate(90deg)" : "rotate(0deg)";
}

function toggleFilters() {
    const panel = document.getElementById("filter-panel");
    panel.classList.toggle("open");
}

function applyFilters(event) {
    event.preventDefault();
    const minBudget = parseFloat(document.getElementById("min-budget").value || 0);
    const region = document.getElementById("region-select").value;
    const payment = document.getElementById("payment-type").value;
    const experience = document.getElementById("experience-select").value;
    const maxHours = parseInt(document.getElementById("max-hours").value || 168);
    const maxDeadline = parseInt(document.getElementById("max-deadline").value || 365);

    document.querySelectorAll(".card").forEach(card => {
        const jobBudget = card.dataset.budget || "";
        const jobRegion = card.dataset.region || "";
        const jobPayment = card.dataset.payment || "";
        const jobExperience = card.dataset.experience || "";
        const jobHours = parseInt(card.dataset.hours_per_week || 168);
        const jobDeadline = parseInt(card.dataset.deadline || 365);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ trim
        const safeJobBudget = jobBudget && typeof jobBudget === 'string' ? jobBudget : "";
        const safeJobRegion = jobRegion && typeof jobRegion === 'string' ? jobRegion : "";
        const safeJobPayment = jobPayment && typeof jobPayment === 'string' ? jobPayment : "";
        const safeJobExperience = jobExperience && typeof jobExperience === 'string' ? jobExperience : "";

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log("–§–∏–ª—å—Ç—Ä—ã:", { minBudget, region, payment, experience, maxHours, maxDeadline });
        console.log("–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:", { safeJobBudget, safeJobRegion, safeJobPayment, safeJobExperience, jobHours, jobDeadline });

        const visible = 
            (parseFloat(safeJobBudget) >= minBudget || safeJobBudget === "") &&
            (!region || safeJobRegion.includes(region)) &&
            (!payment || safeJobPayment.includes(payment)) &&
            (!experience || safeJobExperience.includes(experience)) &&
            jobHours <= maxHours &&
            jobDeadline <= maxDeadline;

        card.style.display = visible ? "block" : "none";
    });
}

function resetFilters() {
    document.getElementById("filter-form").reset();
    applyFilters(new Event("submit"));
}

function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add("fade-out"), 3000);
    setTimeout(() => container.removeChild(toast), 4000);
    const sound = document.getElementById("notify-sound");
    if (sound) {
        sound.currentTime = 0;
        sound.play();
    }
}

async function sendQuery(event) {
    event.preventDefault();
    const query = document.getElementById("query").value;
    const button = document.querySelector('button[type="submit"]');
    console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ç–µ–º–æ–π:", query);

    button.disabled = true;
    button.innerText = "–ü–æ–∏—Å–∫...";
    document.getElementById("loading").style.display = "block";
    document.getElementById("cards").innerHTML = "";
    document.getElementById("job-stats").innerText = "";

    try {
        const response = await fetch("/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
        });
        const jobs = await response.json();
        localStorage.setItem("saved_jobs", JSON.stringify(jobs));

        if (!Array.isArray(jobs) || jobs.length === 0) {
            document.getElementById("cards").innerHTML = "<p class='no-results'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>";
        } else {
            jobs.forEach(job => {
                if (!job.status) job.status = "new";
                addCard(job);
            });
            const takenCount = jobs.filter(job => job.assigned_to).length;
            const totalCount = jobs.length;
            document.getElementById("job-stats").innerText = `üü¶ –ü–æ–ª—É—á–µ–Ω–æ: ${totalCount} | üüß –ó–∞–Ω—è—Ç–æ: ${takenCount}`;
        }
        showToast("‚úÖ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω");
    } catch (error) {
        showToast("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + error.message, "error");
    } finally {
        document.getElementById("loading").style.display = "none";
        button.disabled = false;
        button.innerText = "–ù–∞–π—Ç–∏";
    }
}


function addCard(job) {
    const card = document.createElement("div");
    card.className = "card fade-in";
    card.dataset.budget = job.budget || 0;
    card.dataset.region = job.region || "";
    card.dataset.payment = job.payment || "";
    card.dataset.deadline = job.deadline || 365;
    card.dataset.experience = job.experience || "";
    card.dataset.hours_per_week = job.hours_per_week || 168;
    card.dataset.link = job.link || "";

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –±–µ–∑ trim
    const safeJobTitle = job.title ? job.title : "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
    const safeJobDescription = job.description ? job.description : "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
    const safeJobBudget = job.budget ? job.budget : "‚Äî";

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log("Safe job title:", safeJobTitle);
    console.log("Safe job description:", safeJobDescription);
    console.log("Safe job budget:", safeJobBudget);

    const buttons = `
        <div class="task-actions">
        <button onclick="addToFavorites('${job.link}')">‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button onclick="takeJob('${job.link}')">ü§ù –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
        </div>
    `;

    card.innerHTML = `
        <h3>${safeJobTitle}</h3>
        <p><b>–ë—é–¥–∂–µ—Ç:</b> ${safeJobBudget}</p>
        <p class="job-desc">
            <span class="short">${safeJobDescription.slice(0, 200)}</span>
            <span class="full" style="display:none;">${safeJobDescription}</span>
            <a href="#" onclick="toggleDesc(this); return false;">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</a>
        </p>
        ${buttons}
        <a href="${job.link}" target="_blank" class="card-link">–û—Ç–∫—Ä—ã—Ç—å</a>
    `;

    document.getElementById("cards").appendChild(card);
}

function toggleDesc(link) {
    const shortSpan = link.parentElement.querySelector(".short");
    const fullSpan = link.parentElement.querySelector(".full");

    if (shortSpan.style.display === "none") {
        shortSpan.style.display = "inline";
        fullSpan.style.display = "none";
        link.innerText = "–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ";
    } else {
        shortSpan.style.display = "none";
        fullSpan.style.display = "inline";
        link.innerText = "–°–∫—Ä—ã—Ç—å";
    }
}

function addToFavorites(jobId) {
    fetch('/add_to_favorites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: jobId })
    })
    .then(response => response.json())
    .then(data => {
        showToast(data.message || data.error, data.error ? "error" : "success");
    })
    .catch(error => {
        showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ: " + error.message, "error");
    });
}

function takeJob(link) {
    fetch("/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ link })
    })
    .then(response => response.json())
    .then(data => {
        const card = document.querySelector(`[data-link="${link}"]`);
        if (!card) return;
        const actions = card.querySelector(".task-actions");
        if (!actions) return;

        if (data.status === "assigned") {
            actions.innerHTML = `<span class="task-action locked">üîí –ó–∞–Ω—è—Ç–æ</span>`;
            showToast("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É");
        } else if (data.status === "already assigned") {
            actions.innerHTML = `<span class="task-action locked">üîí –£–∂–µ –∑–∞–Ω—è—Ç–æ</span>`;
            showToast("‚ö†Ô∏è –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –∑–∞–Ω—è—Ç–æ", "error");
        } else {
            showToast("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ", "error");
        }
    })
    .catch(err => showToast("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message, "error"));
}

document.getElementById('notif-filter-toggle').addEventListener('click', () => {
    const panel = document.getElementById('notif-filter-panel');
    panel.classList.toggle('active');
});

function saveUserFilters(event) {
    event.preventDefault();

    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
    const keywordsInput = document.getElementById('filter-keywords').value;
    const minPrice = parseInt(document.getElementById('filter-min-price').value) || 0;
    const category = document.getElementById('filter-category').value;
    const telegramId = document.getElementById('filter-telegram').value;

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    console.log("–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:", keywordsInput);
    console.log("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞:", minPrice);
    console.log("–ö–∞—Ç–µ–≥–æ—Ä–∏—è:", category);
    console.log("Telegram ID:", telegramId);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
    const keywords = typeof keywordsInput === 'string' && keywordsInput
        ? keywordsInput.split(',')
        : [];

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    const filters = {
        keywords,
        min_price: minPrice,
        category,
        telegram_id: telegramId
    };

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    console.log("–§–∏–ª—å—Ç—Ä—ã:", filters);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ localStorage
    localStorage.setItem('userFilters', JSON.stringify(filters));

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/save_filter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filters)
    })
    .then(response => {
        if (response.redirected && response.url.includes('/auth/login')) {
            showToast('‚ùó –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä.', 'error');
        } else {
            return response.json();
        }
    })
    .then(data => {
        console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        if (data?.status === 'saved') {
            showToast('üîî –§–∏–ª—å—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!');
        } else {
            showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞', 'error');
        }
    })
    .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∏–ª—å—Ç—Ä–∞:", err);
        showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞: ' + err.message, 'error');
    });
}

const telegramFromServer = "{{ telegram_id }}";
if (telegramFromServer && telegramFromServer !== "None") {
    const tgInput = document.getElementById("filter-telegram");
    if (tgInput) tgInput.value = telegramFromServer;
}


window.onload = function() {
    const savedJobs = localStorage.getItem("saved_jobs");
    if (savedJobs) {
        const jobs = JSON.parse(savedJobs);
        jobs.forEach(job => {
            if (!job.status) job.status = "new";
            addCard(job);
        });
        const takenCount = jobs.filter(job => job.assigned_to).length;
        const totalCount = jobs.length;
        document.getElementById("job-stats").innerText = `üü¶ –ü–æ–ª—É—á–µ–Ω–æ: ${totalCount} | üüß –ó–∞–Ω—è—Ç–æ: ${takenCount}`;
    }
};
</script>
<script src="{{ url_for('static', filename='shorten_description_guru.js') }}"></script>
</body>
</html>
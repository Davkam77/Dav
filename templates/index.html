<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üîç –ü–æ–∏—Å–∫ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–∫–∞–∑–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .sort-box {
      margin: 20px 0;
      text-align: center;
    }
    .sort-box label {
      margin-right: 10px;
      font-size: 16px;
    }
    .sort-box select {
      padding: 5px;
      font-size: 16px;
    }
    .error-message {
      color: red;
      text-align: center;
      margin: 20px 0;
    }
    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }
    .search-box input {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .search-box button {
      padding: 8px 16px;
      background: #0dcaf0;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
    }
    .search-box button:hover {
      background: #0a9ebb;
    }
  </style>
</head>
<body style="background: url('{{ background }}') no-repeat center center fixed; background-size: cover;">

<!-- –ú–µ–Ω—é -->
<button type="button" class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
<nav id="sideMenu" class="side-menu">
  <ul>
    <li><a href="/index">üè† –ì–ª–∞–≤–Ω–∞—è</a></li>
    <li><a href="/favorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</a></li>
    <li><a href="/my_tasks">üß∞ –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</a></li>
    <li><a href="/completions">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</a></li>
    <li><a href="/logout">üö™ –í—ã–π—Ç–∏</a></li>
  </ul>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="main-content">
  <header>
    <h1 class="glow">üîç –ü–æ–∏—Å–∫ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–∫–∞–∑–æ–≤</h1>
  </header>

  <form class="search-box" onsubmit="sendQuery(event)">
    <input type="text" id="query" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AI 100" required>
    <button type="submit">–ù–∞–π—Ç–∏</button>
  </form>

  <p id="job-stats"></p>
  <div class="sort-box">
    <label for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
    <select id="sort" onchange="sortJobs()">
      <option value="asc">–¶–µ–Ω–µ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
      <option value="desc">–¶–µ–Ω–µ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
    </select>
  </div>
  <div id="cards"></div>
</div>

<script>
function toggleMenu() {
  const menu = document.getElementById("sideMenu");
  menu.classList.toggle("open");
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
let currentJobs = [];

async function sendQuery(event) {
  event.preventDefault();
  const query = document.getElementById("query").value;
  const min_price = document.getElementById("min_price").value;
  const max_price = document.getElementById("max_price").value;
  const region = document.getElementById("region").value;
  const cards = document.getElementById("cards");
  cards.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  try {
    const response = await fetch("/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, min_price, max_price, region })
    });
    if (!response.ok) {
      throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
    }
    const jobs = await response.json();
    console.log("–û—Ç–≤–µ—Ç –æ—Ç /search:", jobs); // –û—Ç–ª–∞–¥–∫–∞
    if (jobs.error) {
      cards.innerHTML = `<p class="error-message">${jobs.error}</p>`;
      return;
    }
    currentJobs = jobs;
    sortJobs();
  } catch (err) {
    cards.innerHTML = `<p class="error-message">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤: ${err.message}</p>`;
    console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", err);
  }
}

function sortJobs() {
  const sortOrder = document.getElementById("sort").value;
  const sortedJobs = [...currentJobs].sort((a, b) => {
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ –±—é–¥–∂–µ—Ç—ã
    const priceA = a.budget && a.budget !== "–ù–µ —É–∫–∞–∑–∞–Ω" ? parseFloat(a.budget.replace(/[^0-9.]/g, '')) || 0 : 0;
    const priceB = b.budget && b.budget !== "–ù–µ —É–∫–∞–∑–∞–Ω" ? parseFloat(b.budget.replace(/[^0-9.]/g, '')) || 0 : 0;
    return sortOrder === "asc" ? priceA - priceB : priceB - priceA;
  });

  const cards = document.getElementById("cards");
  cards.innerHTML = sortedJobs.length > 0 ? sortedJobs.map(job => `
    <div class="card">
      <h3>${job.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</h3>
      <p><b>–ë—é–¥–∂–µ—Ç:</b> ${job.budget || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
      <p>${job.description ? job.description.slice(0, 150) + "..." : "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}</p>
      <a href="${job.link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
      <div class="card-buttons">
        <button class="card-button favorite" onclick="addToFavorites('${job.link}')">‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <a class="card-button take" href="/task/take/${job.id}">ü§ù –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</a>
      </div>
    </div>
  `).join('') : '<p class="error-message">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
}

async function addToFavorites(jobLink) {
  try {
    const res = await fetch("/add_to_favorites", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ job_id: jobLink })
    });
    const result = await res.json();
    alert(result.message || result.error);
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.");
    console.error(err);
  }
}
</script>

</body>
</html>